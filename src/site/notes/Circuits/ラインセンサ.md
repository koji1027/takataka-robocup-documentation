---
{"dg-publish":true,"permalink":"/circuits//"}
---

著者：根岸孝次

ロボカップでアウトオブバウンズを防ぐために必須なラインセンサの原理、作り方をまとめました。

## 物体の色が見える仕組み
私たちの目に映る物体の色は、光の反射によって生まれます。この原理を理解することは、ラインセンサの仕組みを理解する基礎となります。

### 光の反射と色の関係
白色光（太陽光や蛍光灯など）には、赤(R)、緑(G)、青(B)の3原色が含まれています。物体に白色光が当たると、物体の性質によって特定の色の光だけが反射され、その他の色は吸収されます。
以下のような反射の特徴があります。
- 赤い物体は、赤い光だけを反射し、他の色を吸収します
- 黄色い物体は、赤と緑の光を反射します
- 白い物体は、すべての色（赤、緑、青）を反射します
- 黒い物体は、ほとんどすべての光を吸収します
- ![img|483](https://www.cataler.co.jp/train/qa/images/education_01.jpg)
<div style="font-size: 0.5em">出典:https://d2u1z1lopyfwlx.cloudfront.net/thumbnails/ab28ae92-0b58-5152-9852-df79e765d10e/4c6a6ffa-d96c-59d8-8f04-b51ed2860a62.jpg</div>
### センサへの応用
この色の原理は、カラーセンサの設計に直接応用されています。カラーセンサは人間の目と同じように、物体から反射された光のRGB成分を検出します。
具体的には、
1. センサが白色光を物体に照射します
2. 物体から反射された光をRGB各色に分けて検出します
3. 各色の反射量の比率から物体の色を判定します3

このような原理を応用することで、ラインセンサは移動する物体の色情報を正確に読み取ることができます。
![img|445](https://www.rohm.co.jp/documents/11401/7457285/img_01.jpg/b89a1cdf-9013-331c-aa29-bd8f21574fd1?t=1576203765973)
<div style="font-size: 0.5em">出典:https://www.rohm.co.jp/documents/11401/7457285/img_01.jpg/b89a1cdf-9013-331c-aa29-bd8f21574fd1?t=1576203765973</div>
### ロボカップで使うLEDの色
ロボカップサッカーではコートの緑色と白線が区別できれば十分です。上述のような様々な色を見分けられる必要は無く、このセンサを実装するのは過剰です。（サッカーコートのゴールの色は距離が遠すぎるのでこの方式のカラーセンサでは認識できません。カメラを利用してください。）

我々が作るラインセンサは緑色と白色が区別できれば十分だとわかりました。では、そのためにもっとも効果的な方法を考えましょう。例えば、緑色が0(LOW)で、白色が1(HIGH)になったら嬉しいのではないでしょうか？以下ではそうなるようにセンサを考えてみます。

白色はすべての色を反射します。基本的にどんな色を照射しても強く反射されるのでセンサは1(HIGH)を得ます。一方、緑色は緑色を一番強く反射し、赤色と青色を吸収してしまいます。色相環を見れば緑色の捕食が赤色になっていることがわかります。つまり、例えば赤色を照射してあげれば0(LOW)となると考えられます。
![img|293](https://zokeifile.musabi.ac.jp/wpwp/wp-content/uploads/2014/08/059_hue-circle_01.jpg)
<div style="font-size: 0.5em">出典:https://zokeifile.musabi.ac.jp/%E8%89%B2%E7%9B%B8%E7%92%B0/</div>※「○」は反射する。「✕」は吸収する。

実際にロボカップのラインセンサでは赤色光をコートに照射しその反射光の強さを測定することでコート上にいるのかライン上にいるのか判別します。青色も良さそうに思えますがおすすめできません。**ロボカップサッカーでは一方のコートの色として青色が採用されており、ロボットに青色の部分があることが許されていないためです。** また、コートに照射して反射された光が減衰したり、ロボットの外に漏れてしまわないようにLEDとセンサは地面すれすれにつけます。（あまりに地面すれすれにするのは良くないのは言うまでもありません。）

## フォトトランジスタについて
先ほどから光の強度を測定するとずっと言っていますが、センサについて何も解説していなかったのでここで解説します。ラインセンサには**フォトトランジスタ**を利用します。
![img|179](https://akizukidenshi.com/img/goods/L/127315.jpg)
<div style="font-size: 0.5em">出典:https://akizukidenshi.com/img/goods/L/127315.jpg</div>
### 基本構造と動作原理
フォトトランジスタは、光を電気信号に変換する半導体素子で、フォトダイオードとトランジスタを組み合わせた構造を持っています。

### 光電流の発生と増幅
- フォトトランジスタに光が当たると、内部のフォトダイオード部分で光電流が発生します。
- 発生した光電流はNPNトランジスタのベースに流れ込み、hFE倍（数百倍）に増幅されて出力されます。

### 特性と性能
- 電流特性
	- 暗状態（光が当たっていない時）: 暗電流 約10^-9 A
	- 光照射時: 光電流 数mA
	- この電流レベルの大きな差（約10^6倍）を利用して、物体の検出が可能

### 回路での使用方法
一般的な使用例として
- 光が当たっていない時は電流が流れず、後段のトランジスタは0(LOW)
- 光が当たると電流が流れ、後段のトランジスタがオンになる1(HIGH)

## ラインセンサの概観
- LEDを利用して地面に赤色LEDを照射する
	- 普通のLEDでも多分大丈夫だが高輝度LEDというものをつかうと良いかも
		- 光があまりにも強いとLEDからの光が直接フォトトランジスタに入ってしまって線sなとして機能しない。場合によっては直接光が入らないようにカバーを付ける必要がある。
		- 高輝度なLEDほど指向性が強い。（光がまっすぐに出てくる。広がらない）LEDとフォトトランジスタの角度をあわせないと反射光がうまく入射してくれない。
		- 例えば[これ](https://akizukidenshi.com/catalog/g/g105022/)
			- 適当に秋月電子で探したやつだからロボカップで使えるとは一言も言っていない
	- 私は、Neopixelを利用した
		- マイコン内蔵LEDと呼ばれており、色と輝度をプログラムで調整できる。
		- 信号線が1本で済む。数珠つなぎできる。
		- いっぱい搭載して最高輝度で光らせていたらかなり消費電力が大きかった。
		- フルカラーなので遊べて楽しい。
		- はんだ付けが難しい。
		- まさに[これ](https://akizukidenshi.com/catalog/g/g107915/)を使っていた

```cardlink
url: https://akizukidenshi.com/catalog/g/g105022/
title: "5mm赤色LED 624nm 15度 OSR5CA5111A-WY: オプトエレクトロニクス 秋月電子通商-電子部品・ネット通販"
description: "電子部品,通販,販売,半導体,IC,LED,マイコン,電子工作5mm赤色LED 624nm 15度 OSR5CA5111A-WY秋月電子通商 電子部品通信販売"
host: akizukidenshi.com
favicon: https://akizukidenshi.com/apple-touch-icon.png
```

```cardlink
url: https://akizukidenshi.com/catalog/g/g107915/
title: "マイコン内蔵RGBLED WS2812B: オプトエレクトロニクス 秋月電子通商-電子部品・ネット通販"
description: "電子部品,通販,販売,半導体,IC,LED,マイコン,電子工作マイコン内蔵RGBLED WS2812B秋月電子通商 電子部品通信販売"
host: akizukidenshi.com
favicon: https://akizukidenshi.com/apple-touch-icon.png
```


## 回路
この資料で扱う部品構成は以下のとおりです。真似する場合には参考にしてください。
- [WS2812B](https://akizukidenshi.com/catalog/g/g107915/)
	- いわゆるNeopixel
	- 輝度や色を変えられるのでコートや外の光に応じてラインセンサを調節できる。プログラムの項で触れるしきい値を変えなくてもLED側の輝度や色で対応できることもある。
	- 普通のLEDより制御は難しいので初めて作ってみるならLEDをおすすめする
- [NJL7502L](https://akizukidenshi.com/catalog/g/g102325/)
	- フォトトランジスタ
	- ロボカップ界隈で最もメジャー
	- 安くは無いがSSH予算を使えばそんなことはどうでも良い
- 抵抗 10kΩ
	- フォトトランジスタに挟む抵抗
	- 100kΩを使用しているチームもあるが、私達は10kΩでうまく言っているのでこれをおすすめしておく

```cardlink
url: https://akizukidenshi.com/catalog/g/g107915/
title: "マイコン内蔵RGBLED WS2812B: オプトエレクトロニクス 秋月電子通商-電子部品・ネット通販"
description: "電子部品,通販,販売,半導体,IC,LED,マイコン,電子工作マイコン内蔵RGBLED WS2812B秋月電子通商 電子部品通信販売"
host: akizukidenshi.com
favicon: https://akizukidenshi.com/apple-touch-icon.png
```

```cardlink
url: https://akizukidenshi.com/catalog/g/g102325/
title: "照度センサー(フォトトランジスター) 560nm NJL7502L: オプトエレクトロニクス 秋月電子通商-電子部品・ネット通販"
description: "電子部品,通販,販売,半導体,IC,LED,マイコン,電子工作照度センサー(フォトトランジスター) 560nm NJL7502L秋月電子通商 電子部品通信販売"
host: akizukidenshi.com
favicon: https://akizukidenshi.com/apple-touch-icon.png
```

**※補足 上位に食い込みたいなら大事かも**
原理の説明の際に、白色でHIGH、緑色でLOWと説明したのでデジタル入力を使用すれば判別できるはずである。しかし、LEDやフォトトランジスタ、環境の影響で緑色でもHIGHになったり、逆に白色でもLOWとなってしまうことが多々ある。この場合、デジタル入力では判別でいないのでアナログ入力を使うことになる。そこで問題になってくるのがアナログ入力数である。強いチームではフォトトランジスタを1台あたり30個とか使う。（私達のチームでは32個使っていました。かなり多い方。）一方、マイコンのアナログ入力できるピン数は多くても10とかである。そこで、アナログマルチプレクサというものが必要になる。

アナログマルチプレクサとは、複数のアナログ信号を1つのアナログ入力で読むためのICである。（本来の用途がこれなのかは知らないがロボカップではこのように使う。アナログ出力でも利用できそうだが使ったことは無い。）アナログマルチプレクサには、主に以下のピンが生えている。
- 入力ピン（複数）
	- 監視したいアナログ信号を入力するピン
	- 今回の場合、ここに各フォトトランジスタの適切な部分を接続していく
	- 各入力ピンには0~n番と名前がついているはず
- COMピン
	- マイコンのアナログ入力につなぐピン
	- 入力ピンの中から選択されたピンがCOMピント接続されるので、電圧を測定できる
- 選択ピン（複数）
	- どの入力ピンをCOMピンと接続するかを選択する
	- 各ピンの状態から入力ピンを選択する。2進数を用いる。i番目の選択ピンがiビット目になり、各ピンの状態で表現された数字と対応した入力ピンが選択される。
- イネーブルピン
	- このピンでアナログマルチプレクサ自体のON/OFFを選択できる
	- HIGHにするべきか、LOWにするべきかはデータシートを参照しなくてはならない
	- 無いモデルもあるかも

実際に私達が使用したアナログマルチプレクサは[CD74HC4067](https://www.amazon.co.jp/ACEIRMC-CD74HC4067-%E3%82%A2%E3%83%8A%E3%83%AD%E3%82%B0%E3%83%87%E3%82%B8%E3%82%BF%E3%83%AB%E3%83%9E%E3%83%AB%E3%83%81%E3%83%97%E3%83%AC%E3%82%AF%E3%82%B5%E3%83%BC-%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%82%A2%E3%82%A6%E3%83%88%E3%83%9C%E3%83%BC%E3%83%89%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB-%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%83%BC%E7%94%A8/dp/B08XV26WPS?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&crid=SRR4KIJG62KF&dib=eyJ2IjoiMSJ9.JRoWZINWXAOZcWS5Tj3dtA5c94ew5pYxcjQV_IVTvu8F5sC56VkssxTmrlMCWVDBx4yw6iGdTRwWGiy5USIzlgqM4aLjNA8Vl0AOsUVEK41Sa-E7V5CKHT7FsGl2lTMNnNaIoaMxVEpCv5c09e7jCEPGLglIik7vav25qpNwkgtYe1ktTwzar-9dirqJ_Wzt5bMxeBD2ti4xbPKpC2iTIJnaXuwWEY3vqwA-YM89z0KD8kwWtN9sdXOqlT5-vvwk_dG1Xim5gIUfhWzZwImlUUOxTMncPeEGmHkB71nfQ8M.S0mZjXEGzbX4ygyaBv_WaCuU8uymZA8rNEHv_s6Micw&dib_tag=se&keywords=cd74hc4067&qid=1730547278&sprefix=cd74hc406,aps,161&sr=8-5)です。Amazonでモジュールで販売されていたやつをハンダごてで熱して外して自分たちの基板に取り付けていました。digikeyなどで部品単体として販売されているのでそれを買ってもいいのですが、Amazonのやつは異様に安かったのでこっちを使いました。偽物説もかなり濃厚ですが動いているのでこれを使っていました。

```cardlink
url: https://www.amazon.co.jp/ACEIRMC-CD74HC4067-%E3%82%A2%E3%83%8A%E3%83%AD%E3%82%B0%E3%83%87%E3%82%B8%E3%82%BF%E3%83%AB%E3%83%9E%E3%83%AB%E3%83%81%E3%83%97%E3%83%AC%E3%82%AF%E3%82%B5%E3%83%BC-%E3%83%96%E3%83%AC%E3%83%BC%E3%82%AF%E3%82%A2%E3%82%A6%E3%83%88%E3%83%9C%E3%83%BC%E3%83%89%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB-%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%83%BC%E7%94%A8/dp/B08XV26WPS?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&crid=SRR4KIJG62KF&dib=eyJ2IjoiMSJ9.JRoWZINWXAOZcWS5Tj3dtA5c94ew5pYxcjQV_IVTvu8F5sC56VkssxTmrlMCWVDBx4yw6iGdTRwWGiy5USIzlgqM4aLjNA8Vl0AOsUVEK41Sa-E7V5CKHT7FsGl2lTMNnNaIoaMxVEpCv5c09e7jCEPGLglIik7vav25qpNwkgtYe1ktTwzar-9dirqJ_Wzt5bMxeBD2ti4xbPKpC2iTIJnaXuwWEY3vqwA-YM89z0KD8kwWtN9sdXOqlT5-vvwk_dG1Xim5gIUfhWzZwImlUUOxTMncPeEGmHkB71nfQ8M.S0mZjXEGzbX4ygyaBv_WaCuU8uymZA8rNEHv_s6Micw&dib_tag=se&keywords=cd74hc4067&qid=1730547278&sprefix=cd74hc406,aps,161&sr=8-5
title: "Amazon.co.jp"
host: www.amazon.co.jp
```
（**補足終わり**）

### LED部分
### Neopixel
![ws2812b_1.jpg|249](/img/user/Circuits/ws2812b_1.jpg)
Neopixelには4つの端子があります。上の画像は回路CADでのシンボルです。
- VDD
	- 電源入力ピン
	- 3.3Vでは動かないので5Vを入力する
		- マイコンが3.3V駆動であっても5Vを入力する。信号はマイコンから一方的に送るのでマイコンに逆流して壊れることは無い。
- DOUT
	- 信号出力
	- 次のNeopixelに信号を伝達する
		- 次のNeopixelのDINにつないでやれば良い
		- Neopixelは数珠つなぎになっていて、各Neopixelは受け取ったデータから自分に関するデータだけ抜き出した残りを次のマイコンへと伝える仕組みになっている
		- Neopixelの接続と配置を工夫すると配線が楽になる。何も考えないで配置するとひどいことになる。（当たり前）
- VSS
	- グラウンド
	- 聞き慣れないと思うがGNDをVSSと書くこともある
- DIN
	- 信号入力
	- 前のNeopixelのDOUTとつなぐ
	- 先頭のNeopixelはマイコンとつないでやれば良い
		- マイコンのどのピンでも基本的に制御できたはず
![ws2812b_2.png|271](/img/user/Circuits/ws2812b_2.png)
実際に回路CAD上でつないでみた図。最後のNeopixelのDOUTは未接続で問題ない。

### フォトトランジスタ
![img](https://akizukidenshi.com/img/goods/L/127315.jpg)
フォトトランジスタの画像をよく見ると、長い足と短い足がある。見た目がLEDと非常にそっくり。長い足を **Corrector** 、短い足を **Emitter** と呼ぶ。まあ、LEDと同じで順に +, - だと思ってもらって問題ない。
![phototransister.png|314](/img/user/Circuits/phototransister.png)
回路CADでつないだ様子。電源として 3.3V を使用しているが、これはマイコンの電源電圧がが3.3V であるためであり、5Vのマイコンを使用している場合には5Vでも構わない。回路をよく見ると、Emitterと抵抗の間の配線名がL4となっていると思う。反射光の強度がここの電圧に反映されるので、ここをアナログ入力（デジタル入力でも良い）で監視する。（名前がL4であることに深い意味は無い。）以下のように複数作って、別々に監視してやるのが良い。
![phototransister2.png|408](/img/user/Circuits/phototransister2.png)

### （補足）アナログマルチプレクサ
勢い余ってアナログマルチプレクサを紹介してしまったので解説します。
![cd74_1.png|404](/img/user/Circuits/cd74_1.png)
上の画像は[CD74HC4067のデータシート](https://www.ti.com/jp/lit/ds/symlink/cd74hc4067.pdf?ts=1730549281611)に掲載されているピンマップです。
- Vcc
	- 電源（3.3V or 5V）
- COMMON INPUT/OUTPUT
	- COMピン
- S
	- 選択ピン
	- 何番の入力ピンが選択されるかは以下の式
		- S1 + 2 × S2 + 4 × S3 + 8 × S4
- E
	- イネーブルピン
	- CD74HC4067の場合、LOWにしておけば良い
	- HIGHの場合、機能しない
	- グラウンドにつないでおく
- I
	- 入力ピン
![cd74_2.png|412](/img/user/Circuits/cd74_2.png)
上の画像がデータシートをもとに回路CADで回路を書いてみたもの。特に言うことは無い。

## プログラム
### アナログマルチプレクサを使用しない場合
以下のようなコードを書いてあげれば良いと思います。Neopixelの光らせかたは自分で調べてください。難しくないので。わからなかったら聞いて。
```c++:linesensor_simple.cpp
#include <Arduino.h>

const int LINESENSOR_NUM = 5; //フォトトランジスタの個数、こういうの大事
const int LINESENSOR_PIN[LINESENSOR_NUM] = {A0, A1, A2, A3, A4}; //各センサのピン

void setup() {
	Serial.begin(115200) //シリアル通信を開始、デバッグ用
}

void loop() {
	int sensorValues[LINESENSOR_NUM]; //結果を格納する配列
	for (int i = 0; i < LINESENSOR_NUM; i++) {
		sensorValues[i] = analogRead(LINESENSOR_PIN[i]); //アナログ入力で読む
	}

	for (int i = 0; i < LINESENSOR_NUM; i++) {
		Serial.print(sensorValues[i]); //結果を出力、改行しない
		Serial.print("\t"); //値と値の間にtabを入れるとスペースと異なりきれいに出力できる
	}
	Serial.print("\n") //改行も忘れずに

	delay(1000);
}
```

各フォトトランジスタにスマホのLEDととかをかざしてみると値が変化すると思います。変化しなかったらなにか問題があると思います。コート上で白線上を行ったり来たりさせて値の変化を観察しましょう。ライン上にいるかどうかのしきい値はなんとなくで大丈夫だと思います。

### （補足）アナログマルチプレクサを使用する場合
```c++:linesensor_mux.cpp
#include <Arduino.h>

const int LINESENSOR_NUM = 16; //フォトトランジスタの個数、こういうの大事
const int COM_PIN = A0; //COMピン
const int SELECT_PIN[4] = {D5, D6, D7, D8} //選択ピン、番号は適当

void setup() {
	Serial.begin(115200) //シリアル通信を開始、デバッグ用

	for (int i = 0; i < 4; i++) {
		pinMode(SELECT_PIN[i], OUTPUT);
	}
}

void loop() {
	int sensorValues[LINESENSOR_NUM]; //結果を格納する配列
	for (int i = 0; i < LINESENSOR_NUM; i++) {
		for (int j = 0; j < 4; j++) {
			digitalWrite(SELECT_PIN[j], (i >> j) & 1);
		}
		sensorValues[i] = analogRead(COM_PIN);
	}

	for (int i = 0; i < LINESENSOR_NUM; i++) {
		Serial.print(sensorValues[i]); //結果を出力、改行しない
		Serial.print("\t"); //値と値の間にtabを入れるとスペースと異なりきれいに出力できる
	}
	Serial.print("\n") //改行も忘れずに

	delay(1000);
}
```
ビット演算をうまく活用すると選択ピンの出力を簡単に変更できるのでおすすめです。アナログマルチプレクサを使うならある程度自分で何でもできないといけないと思うので特に解説しません。

## 補足事項
色々補足があってごめんなさい。最後に**エンジェルリング**といういものを軽く紹介します。
![img|354](https://cdn-ak.f.st-hatena.com/images/fotolife/r/robocup-zunda/20230504/20230504164310.jpg)
エンジェルリングとはラインセンサを円形に配置したものをさします。円形にラインセンサを配置することで、機体が踏んでいる白線の位置や角度を計算することができます。使い方によっては自己位置推定にも少しつながります。ただ、大量のラインセンサが必要となるのでアナログマルチプレクサは必須になると思いいます。加えて、コートの隅の角やゴールエリアの白線の角などでは処理がかなり難しくなります。この欠点を補うために機体の前後左右の端に独立したラインセンサを4つ付けて、それらとエンジェルリングを組み合わせてより高度なライン処理を行っているチームもあります。余裕があれば調べてみたりすると良いと思います。円形ボールセンサの計算方法も参考にできると思います。

#### おすすめサイト
```cardlink
url: https://rcjskycrew.livedoor.blog/archives/10745181.html
title: "エンジェルリングのススメ 前編 : SKY Crew Lab"
description: "こんにちは。二人目のソフト担当のSYです。ラインセンサや戦略といった全体的なプログラミングをしています。   今回は、SKY Crewの世界大会機の最大の特徴の一つである、円形ラインセンサ（エンジェルリング）について話していきたいと思います。   エンジェルリングを用い"
host: rcjskycrew.livedoor.blog
favicon: https://parts.blog.livedoor.jp/favicon.ico
image: https://livedoor.blogimg.jp/rcjskycrew/imgs/f/8/f85ffe31-s.jpg
```

```cardlink
url: http://blog.livedoor.jp/revolution_include/archives/2038835.html
title: "ロボット紹介(センサー編) : Revolution_Include"
description: "皆さんこんにちはRevolution_includeのネタ＆制御担当の太鼓の暇人(@Taikono_Himazin)です。 今回もRoboCup Junior Soccer 2017 japan Openに出場したロボットの紹介です。ロボット紹介(センサー編)今回はこのロボットのセンサー類について紹介していきます。"
host: blog.livedoor.jp
favicon: https://livedoor.blogimg.jp/revolution_include/imgs/8/9/890847d4.jpg
image: https://livedoor.blogimg.jp/revolution_include/imgs/b/a/bae18b5e-s.jpg
```

```cardlink
url: https://yuta.techblog.jp/archives/24145402.html
title: "ラインセンサー技術 : Yuta’s Blog"
description: "ロボカップジュニア サッカーにおけるアウトオブバウンズ対策の根幹となるラインセンサー技術をCIAO Tezukayamaの2019機をベースに紹介します。"
host: yuta.techblog.jp
favicon: https://livedoor.blogimg.jp/yutatech/imgs/8/1/81dee1f6.png
image: https://livedoor.blogimg.jp/yutatech/imgs/0/1/01e4ff73-s.png
```
